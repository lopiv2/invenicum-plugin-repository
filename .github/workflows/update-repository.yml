name: Update Repository Index

on:
  push:
    branches:
      - main
    paths:
      - 'templates/**'

# ðŸš© IMPORTANTE: Permisos para que la Action pueda escribir el commit
permissions:
  contents: write

jobs:
  update-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Generate repository.json
        run: |
          # 1. Crear la estructura base
          echo '{' > repository.json
          echo '  "name": "Invenicum Market",' >> repository.json
          echo '  "templates": [' >> repository.json
          
          # 2. Variable para manejar las comas entre objetos
          first=true
          
          # 3. Iterar sobre los archivos
          for file in templates/*.json; do
            # Saltamos si no hay archivos o es el propio repository.json por error
            [ -e "$file" ] || continue
            
            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> repository.json
            fi
            
            # ðŸš© Extraemos los datos. Ajustamos el download_url dinÃ¡micamente.
            # Usamos jq para filtrar y limpiar el objeto
            cat "$file" | jq --arg url "https://raw.githubusercontent.com/${{ github.repository }}/main/$file" \
            '{
              id: .id,
              name: .name,
              description: .description,
              category: .category,
              tags: (.tags // []),
              author: (.author // .authorName // "Invenicum Team"),
              authorAvatarUrl: .authorAvatarUrl,
              download_url: $url,
              downloadCount: (.downloadCount // 0)
              version: (.version // 1.0)
            }' >> repository.json
          done
          
          echo '  ]' >> repository.json
          echo '}' >> repository.json

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add repository.json
          
          # Solo procedemos si hay cambios reales en el Ã­ndice
          if ! git diff --quiet --staged; then
            git commit -m "bot: update repository.json index"
            
            # ðŸš© EL TRUCO: Traer los cambios del merge del PR y poner nuestro commit encima
            git pull --rebase origin main
            
            git push origin main
          else
            echo "No changes to repository.json"
          fi
