name: Update Plugins Index

on:
  push:
    branches:
      - main
    paths:
      - 'plugins/**' # Se activa al a침adir, editar o borrar archivos en esta carpeta

permissions:
  contents: write

jobs:
  update-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Regenerate Plugins Index
        run: |
          # 1. Definir nombres de archivos
          INDEX_FILE="repository_plugin.json"
          TEMP_FILE="new_plugin_index.json"

          # 2. Crear la estructura base del nuevo 칤ndice
          echo '{"name": "Invenicum Market", "plugins": []}' > $TEMP_FILE

          # 3. Iterar sobre los archivos que existen actualmente en plugins/
          for file in plugins/*.json; do
            # Ignorar si es el propio 칤ndice
            [[ "$file" == *"$INDEX_FILE"* ]] && continue
            [ -e "$file" ] || continue
            
            echo "Procesando plugin: $file..."
            
            ID=$(jq -r '.id' "$file")
            URL="https://raw.githubusercontent.com/${{ github.repository }}/main/$file"
            
            # 游뛀 PERSISTENCIA DE CONTADORES:
            # Buscamos el downloadCount actual en el 칤ndice que ya est치 en el repo
            if [ -f "$INDEX_FILE" ]; then
              # Buscamos el ID y extraemos su contador. Si no existe, devolvemos 0.
              CURRENT_COUNT=$(jq --arg id "$ID" '.plugins[] | select(.id == $id) | .downloadCount' $INDEX_FILE || echo "0")
            else
              CURRENT_COUNT=0
            fi
            
            # Limpiar valor si jq devuelve null o errores de texto
            [[ -z "$CURRENT_COUNT" || "$CURRENT_COUNT" == "null" ]] && CURRENT_COUNT=0

            # 4. Construir el objeto JSON del Plugin (Ajustado a tu PluginService)
            PLUGIN=$(jq --arg url "$URL" --argjson count "$CURRENT_COUNT" '{
              "id": .id,
              "name": .name,
              "description": (.description // ""),
              "version": (.version // "1.0.0"),
              "author": (.author // "Community"),
              "slot": (.slot // "dashboard_top"),
              "download_url": $url,
              "downloadCount": $count
            }' "$file")

            # 5. A침adir al nuevo 칤ndice temporal
            jq --argjson p "$PLUGIN" '.plugins += [$p]' $TEMP_FILE > tmp.json && mv tmp.json $TEMP_FILE
          done

          # 6. Reemplazar el 칤ndice oficial
          mv $TEMP_FILE $INDEX_FILE

      - name: Validate and Push
        run: |
          jq empty repository_plugin.json # Validar JSON
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add repository_plugin.json
          
          if ! git diff --quiet --staged; then
            git commit -m "bot: sync plugin index (preserving counts & handling removals)"
            git pull --rebase origin main
            git push origin main
          else
            echo "Sin cambios en el cat치logo de plugins."
          fi
